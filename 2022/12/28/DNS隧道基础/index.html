<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/wan1/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/wan1/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/wan1/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/wan1/images/logo.svg" color="#222">

<link rel="stylesheet" href="/wan1/css/main.css">


<link rel="stylesheet" href="/wan1/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wanheiqiyihu.gitee.io","root":"/wan1/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="DNS隧道基础1DNS隧道，是隧道技术中的一种。当我们的HTTP、HTTPS这样的上层协议、正反向端口转发都失败的时候，可以尝试使用DNS隧道。DNS隧道很难防范，因为平时的业务也好，使用也罢，难免会用到DNS协议进行解析，所以防火墙大多对DNS的流量是放行状态。这时候，如果我们在不出网机器构造一个恶意的域名（***.xxx.ga），本地的DNS服务器无法给出回答时，就会以迭代查询的方式通过互联网">
<meta property="og:type" content="article">
<meta property="og:title" content="DNS隧道基础">
<meta property="og:url" content="https://wanheiqiyihu.gitee.io/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="十三の博客">
<meta property="og:description" content="DNS隧道基础1DNS隧道，是隧道技术中的一种。当我们的HTTP、HTTPS这样的上层协议、正反向端口转发都失败的时候，可以尝试使用DNS隧道。DNS隧道很难防范，因为平时的业务也好，使用也罢，难免会用到DNS协议进行解析，所以防火墙大多对DNS的流量是放行状态。这时候，如果我们在不出网机器构造一个恶意的域名（***.xxx.ga），本地的DNS服务器无法给出回答时，就会以迭代查询的方式通过互联网">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228151559428.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228162144458.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228171835939.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228172735624.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228173805409.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228174532671.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228175259660.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228175505332.png">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/640">
<meta property="og:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/640">
<meta property="article:published_time" content="2022-12-28T10:09:36.000Z">
<meta property="article:modified_time" content="2022-12-28T10:10:23.892Z">
<meta property="article:author" content="十三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanheiqiyihu.gitee.io/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228151559428.png">

<link rel="canonical" href="https://wanheiqiyihu.gitee.io/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-cn'
  };
</script>

  <title>DNS隧道基础 | 十三の博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/wan1/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">十三の博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/wan1/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/wan1/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-ctf做题笔记">

    <a href="/wan1/categories/Experience" rel="section"><i class="download fa-fw"></i>CTF做题笔记</a>

  </li>
        <li class="menu-item menu-item-python">

    <a href="/wan1/categories/python" rel="section"><i class="download fa-fw"></i>python</a>

  </li>
        <li class="menu-item menu-item-java">

    <a href="/wan1/categories/java" rel="section"><i class="download fa-fw"></i>java</a>

  </li>
        <li class="menu-item menu-item-读书笔记">

    <a href="/wan1/categories/readbook" rel="section"><i class="download fa-fw"></i>读书笔记</a>

  </li>
        <li class="menu-item menu-item-渗透测试">

    <a href="/wan1/categories/penetration" rel="section"><i class="download fa-fw"></i>渗透测试</a>

  </li>
        <li class="menu-item menu-item-基础">

    <a href="/wan1/categories/basic" rel="section"><i class="download fa-fw"></i>基础</a>

  </li>
        <li class="menu-item menu-item-轮子">

    <a href="/wan1/categories/lunzi" rel="section"><i class="download fa-fw"></i>轮子</a>

  </li>
        <li class="menu-item menu-item-漏洞库">

    <a href="/wan1/categories/fuxian" rel="section"><i class="download fa-fw"></i>漏洞库</a>

  </li>
        <li class="menu-item menu-item-工具">

    <a href="/wan1/categories/tools" rel="section"><i class="download fa-fw"></i>工具</a>

  </li>
        <li class="menu-item menu-item-代码审计">

    <a href="/wan1/categories/daima" rel="section"><i class="download fa-fw"></i>代码审计</a>

  </li>
        <li class="menu-item menu-item-逆向">

    <a href="/wan1/categories/nixiang" rel="section"><i class="download fa-fw"></i>逆向</a>

  </li>
        <li class="menu-item menu-item-应急响应">

    <a href="/wan1/categories/yingji" rel="section"><i class="download fa-fw"></i>应急响应</a>

  </li>
        <li class="menu-item menu-item-免杀">

    <a href="/wan1/categories/miansha" rel="section"><i class="download fa-fw"></i>免杀</a>

  </li>
        <li class="menu-item menu-item-靶场">

    <a href="/wan1/categories/bachang" rel="section"><i class="download fa-fw"></i>靶场</a>

  </li>
        <li class="menu-item menu-item-cve申请">

    <a href="/wan1/categories/cve" rel="section"><i class="download fa-fw"></i>cve申请</a>

  </li>
        <li class="menu-item menu-item-c语言">

    <a href="/wan1/categories/c" rel="section"><i class="download fa-fw"></i>c语言</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://wanheiqiyihu.gitee.io/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/wan1/images/avatar.gif">
      <meta itemprop="name" content="十三">
      <meta itemprop="description" content="潜心学习，不骄不躁">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十三の博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DNS隧道基础
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-28 18:09:36 / 修改时间：18:10:23" itemprop="dateCreated datePublished" datetime="2022-12-28T18:09:36+08:00">2022-12-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/wan1/categories/basic/" itemprop="url" rel="index"><span itemprop="name">-basic</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="DNS隧道基础"><a href="#DNS隧道基础" class="headerlink" title="DNS隧道基础"></a>DNS隧道基础</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DNS隧道，是隧道技术中的一种。当我们的HTTP、HTTPS这样的上层协议、正反向端口转发都失败的时候，可以尝试使用DNS隧道。DNS隧道很难防范，因为平时的业务也好，使用也罢，难免会用到DNS协议进行解析，所以防火墙大多对DNS的流量是放行状态。这时候，如果我们在不出网机器构造一个恶意的域名（***.xxx.ga），本地的DNS服务器无法给出回答时，就会以迭代查询的方式通过互联网定位到所查询域的权威DNS服务器。最后，这条DNS请求会落到我们提前搭建好的恶意DNS服务器上，于是乎，我们的不出网主机就和恶意DNS服务器交流上了。</span><br></pre></td></tr></table></figure>

<p><strong>搭建DNS隧道的工具目前有iodine，dnscat，dns2tcp等</strong>。</p>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="DNS的集中资源记录类型"><a href="#DNS的集中资源记录类型" class="headerlink" title="DNS的集中资源记录类型"></a>DNS的集中资源记录类型</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.主机记录（A记录）</span><br><span class="line">主机记录可以将DNS中的域名称对应到IPv4地址。</span><br><span class="line">2.PTR</span><br><span class="line">PTR可以定义某个对应的域名。</span><br><span class="line">3.CNAME记录，通常称别名解析</span><br><span class="line">CNAME记录可以将注册的不同域名都转到一个域名记录上，由这个域名记录同意解析管理，与A记录不同的是，CNAME别名记录设置的可以是一个域名的描述而不一定是IP地址。</span><br><span class="line">4.NS（Name Server）记录是域名服务器记录</span><br><span class="line">NS记录用来置顶该域名是由那个DNS服务器来进行解析的，可以吧一个域名的不同二级域名分别只想到不同的DNS系统来解析。</span><br><span class="line">5.TXT记录</span><br><span class="line">TXT记录一般是为某条记录设置说明，比如你新建了一条a.com的TXT记录，TXT记录内容“this is a test TXT record&quot;的字样了。</span><br></pre></td></tr></table></figure>

<h2 id="DNS协议解析过程"><a href="#DNS协议解析过程" class="headerlink" title="DNS协议解析过程"></a>DNS协议解析过程</h2><p>dns协议解析过程分为两种，迭代查询和递归查询。</p>
<p>迭代查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本地域名服务器像根域名服务器发送请求报文，根域名服务器直接给出ip地址或者告诉本地域名服务器下一步应该去向另一个域名服务器A进行查询。同理,A域名服务器直接给出ip地址或者告诉本地域名服务器下一步应该去查询B域名服务器。过程以此类推，知道找到ip地址为止。</span><br></pre></td></tr></table></figure>

<p>递归查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户机向本地域名服务器查询，如果本地域名服务器的缓存中没有需要查询的ip地址，那么本地域名服务器会以客户机的身份（代替本机查询），向根域名服务器发送请求报文。</span><br></pre></td></tr></table></figure>

<h2 id="DNS隧道"><a href="#DNS隧道" class="headerlink" title="DNS隧道"></a>DNS隧道</h2><p>DNS隧道是隐蔽信道的一种，通过将其他协议封装在DNS协议中进行通信。封装由客户端完成，将DNS流量还原成正常的流量由服务器完成。DNS隧道攻击利用了防火墙放行DNS单特点以及协议解析流程来实现的。</p>
<p>而DNS隧道也要分为两种，一种是直连型，一种是域名型DNS隧道（中继）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直连型DNS隧道：</span><br><span class="line">客户端直接和指定的目标DNS Server进行UDPsocket套接字连接，通过将数据编码封装在DNS协议中进行通信，这种方式速度快，但是隐蔽性比较弱，很容易被探测到，但如果客户端指定了信任的DNS解析服务器，那么将会被白名单限制在外。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">域名型DNS隧道（中继）：</span><br><span class="line">通过DNS迭代查询实现的中继隧道，比较隐蔽，但同时因为数据包到达目标DNS Server前需要经过多个节点，所以速度上较直连慢很多。中继过程中的一个关键点是对DNS缓存机制的规避，因为如果解析的域名在Local DNS 中已经有缓存，那么Local DNS 就不会继续发送数据包，所以在构造请求中，每次查询的域名需要不同或者是已过期的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DNS隧道建立的过程：</span><br><span class="line">Step 1：受控PC机将数据封装进DNS数据包里，像局域网内部的本地域名服务器请求查询aaa.com</span><br><span class="line">Step 2：本地域名服务器透过防火墙向根域名服务器发送查询请求</span><br><span class="line">Step 3：经过大量重定向，查询请求最终要aaa.com的权威域名服务器</span><br><span class="line">Step 4：aaa.com权威域名服务器是在攻击者的控制下，解析发送过来的DNS数据包并发送回应包</span><br><span class="line">Step 5：DNS回应包穿透防火墙</span><br><span class="line">Step 6：DNS回应包进入内网</span><br><span class="line">Step 7：本地域名服务器将回应包返回给受控PC机</span><br><span class="line">Step 8：受控PC机解析DNS回应包里的数据，得到新的指令</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DNS Beacon原理：</span><br><span class="line">利用DNS请求应答机制作为攻击渗透到命令控制通道，吧C&amp;C服务器指令封装到DNS相应报文中，以此控制被控段主机。</span><br></pre></td></tr></table></figure>

<p>发送端将隐蔽数据信息切分并且编码后封装到DNS报文域名中进行传输，每一级域名长度为63，域名总长度不超过253，接收端收到DNS报文后提取域名中的隐蔽信息字段进行解码重组还原得到IP报文。主要的工具有DNSCat,Iodine等</p>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>需要一个域名和一个公网服务器。</p>
<h2 id="iodine-DNS隧道搭建"><a href="#iodine-DNS隧道搭建" class="headerlink" title="iodine DNS隧道搭建"></a>iodine DNS隧道搭建</h2><p>值得一提到是iodine（碘）的原子序数为53，这恰好是DNS端口号，故取名为iodine。</p>
<p><code>apt install iodine</code>命令会同时安装服务端与客户端。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dnspod：https://www.dnspod.cn，在dnspod中添加刚申请的域名，然后dnspod会给出两条dns服务器地址。</span><br><span class="line"></span><br><span class="line">前往域名注册商处修改为 DNSPod 所属服务器。(阿里云中</span><br><span class="line">dns修改后有24-48小时dns生效时间。)</span><br></pre></td></tr></table></figure>

<p>等了一天DNS生效，继续配置。</p>
<p>dnspod得到域名的管理权之后，在里面添加两条解析记录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第一条A类记录，告诉域名系统，&quot;www.xxx&quot;的IP地址是&quot;121.xxx.xxx.xxx&quot;。</span><br><span class="line"></span><br><span class="line">第二条NS记录，告诉域名系统，&quot;ns.xxx&quot;的域名由&quot;www.xxx&quot;进行解析。</span><br><span class="line"></span><br><span class="line">到此前期准备工作就已经完成了，已经将域名绑定到了我们的公网服务器上。</span><br></pre></td></tr></table></figure>

<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228151559428.png" alt="image-20221228151559428"></p>
<p>但是更改之后，也不会马上生效，需要等待一段时间，等各地的运营商的缓存刷新才可以。</p>
<h3 id="服务端："><a href="#服务端：" class="headerlink" title="服务端："></a>服务端：</h3><p>在公网服务器上部署iodine服务端。(需要root权限运行)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iodined -f -c -P 123.com 192.168.200.1 ns.xxx -DD</span><br><span class="line"></span><br><span class="line">\-f：在前台运行</span><br><span class="line"></span><br><span class="line">\-c：禁止检查所有传入请求的客户端IP地址。</span><br><span class="line"></span><br><span class="line">\-P：客户端和服务端之间用于验证身份的密码。</span><br><span class="line"></span><br><span class="line">\-D：指定调试级别，-DD指第二级。“D”的数量随级别增加。</span><br></pre></td></tr></table></figure>

<p>其中ns.xxx就是在腾讯dns设置的ns记录那个</p>
<p>这里的192.168.200.1为自定义局域网虚拟IP地址，建议不要与现有网段冲突。</p>
<p>执行完该命令之后会新生成一个dns0虚拟网卡，ip地址就是刚才命令中输入的ip地址(192.168.200.1)。</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228162144458.png" alt="image-20221228162144458"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**ubuntu默认53端口是打开的，通过下面命令关闭掉53端口**</span><br><span class="line"></span><br><span class="line">rm /etc/resolv.conf&amp;&amp;echo &quot;nameserver x.x.x.x&quot; &gt;&gt; /etc/resolv.conf 配置dns服务器(x.x.x.x改为dns服务器,8.8.8.8等)</span><br><span class="line"></span><br><span class="line">systemctl stop systemd-resolved 停止该进程</span><br><span class="line"></span><br><span class="line">systemctl disable systemd-resolved 关闭开机自启动</span><br></pre></td></tr></table></figure>

<h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a>客户端：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">客户端我使用的kali，kali自带iodine工具。</span><br><span class="line"></span><br><span class="line">iodine -f -P 123.com ns.xxx -M 200</span><br><span class="line"></span><br><span class="line">-r：iodine有时会自动将DNS隧道切换为UDP隧道，该参数的作用是强制在任何情况下使用DNS隧道</span><br><span class="line"></span><br><span class="line">-M：指定上行主机的大小。</span><br><span class="line"></span><br><span class="line">-m：调节最大下行分片的大小。</span><br><span class="line"></span><br><span class="line">-f：在前台运行</span><br><span class="line"></span><br><span class="line">-T：指定DNS请求类型TYPE，可选项有NULL、PRIVATE、TXT、SRV、CNAME、MX、A。</span><br><span class="line"></span><br><span class="line">-O：指定数据编码规范。</span><br><span class="line"></span><br><span class="line">-P：客户端和服务端之间用于验证身份的密码。</span><br><span class="line"></span><br><span class="line">-L：指定是否开启懒惰模式，默认开启。</span><br><span class="line"></span><br><span class="line">-I：指定两个请求之间的时间间隔。</span><br></pre></td></tr></table></figure>

<p>值得注意的是：dns服务使用的是udp的53端口，而不是tcp的。</p>
<p>同时即使链接成功了也会产生编码错误，在客户端使用如下命令解决。</p>
<p><code>iodine -f -P 123.com ns.xxx  -M 200 -O base64</code></p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228171835939.png" alt="image-20221228171835939"></p>
<p>这边已经链接成功了，而且也给我们分配了一个虚拟ip,200.3</p>
<p>现在我们通过客户端ping一下服务端的虚拟ip，发现ping的通，则dns隧道建立成功。</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228172735624.png" alt="image-20221228172735624"></p>
<p>（就是延迟有点高的啊）</p>
<h3 id="frp搭建隧道"><a href="#frp搭建隧道" class="headerlink" title="frp搭建隧道"></a>frp搭建隧道</h3><p>先在服务器上打开frp</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228173805409.png" alt="image-20221228173805409"></p>
<p>随后在本地搭建frp客户端</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228174532671.png" alt="image-20221228174532671"></p>
<p>注意，这里的ip就不是公网上的了，而是dns隧道中服务器的虚拟ip，现在我们相当于在6005端口中又嵌套了一个socket隧道。（上面配置搞忘打一个中括号了，记得加上）</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228175259660.png" alt="image-20221228175259660"></p>
<p>直接访问公网的6005端口</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/image-20221228175505332.png" alt="image-20221228175505332"></p>
<p>可以看到成功建立链接，就是有点小慢（毕竟是dns隧道。</p>
<p>为了做实验，我还专门吧服务器的其他端口用防火墙拦截了，只留下了一个dns的端口，结果还是成功的。（当然对面的服务器必须把你开socket代理的端口打开才可以哦，是tcp的，）</p>
<p>当然后续还有一些工具可以搭建dns隧道，后面我的博客中会陆续补充在工具分类里面。（<strong>dnscat2</strong>、<strong>dns2tcp</strong>）</p>
<h1 id="各种工具的利用环境"><a href="#各种工具的利用环境" class="headerlink" title="各种工具的利用环境"></a>各种工具的利用环境</h1><h3 id="1-外-gt-内"><a href="#1-外-gt-内" class="headerlink" title="1.外-&gt;内"></a><strong>1.外-&gt;内</strong></h3><p>iodine和dnscat2使用环境：目标是内网，并且只有dns出网的情况下，通过自己的公网服务器搭建到目标的dns隧道，从而通过公网服务器代理进入目标内网，遨游目标内网。</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/640" alt="图片"></p>
<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="2-内-gt-外"><a href="#2-内-gt-外" class="headerlink" title="2.内-&gt;外"></a><strong>2.内-&gt;外</strong></h3><p>dns2tcp使用的环境是：自己在一个内网里面，自己所处的环境不出网，但是dns可以出网，就可以用过dns2tcp搭建一个dns隧道，从而可以访问到互联网环境。</p>
<p>典型环境：在学校连接到wifi之后，必须要认证登陆，不然不能上网，但是浏览器又能加载出登陆界面，此情况就是dns出网，可以通过dns2tcp搭建dns隧道绕过认证登陆。</p>
<p><img src="/wan1/wan1/2022/12/28/DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/640" alt="图片"></p>
<p>（图是偷的外面的，有水印就别建议了）</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/wan1/2022/12/25/%E5%88%9D%E6%8E%A2%E5%86%85%E5%AD%98%E9%A9%AC/" rel="prev" title="初探内存马">
      <i class="fa fa-chevron-left"></i> 初探内存马
    </a></div>
      <div class="post-nav-item">
    <a href="/wan1/2022/12/29/icmp%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80/" rel="next" title="icmp隧道基础">
      icmp隧道基础 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DNS%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">DNS隧道基础</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS%E7%9A%84%E9%9B%86%E4%B8%AD%E8%B5%84%E6%BA%90%E8%AE%B0%E5%BD%95%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.1.</span> <span class="nav-text">DNS的集中资源记录类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">DNS协议解析过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS%E9%9A%A7%E9%81%93"><span class="nav-number">2.3.</span> <span class="nav-text">DNS隧道</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#iodine-DNS%E9%9A%A7%E9%81%93%E6%90%AD%E5%BB%BA"><span class="nav-number">3.1.</span> <span class="nav-text">iodine DNS隧道搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A"><span class="nav-number">3.1.1.</span> <span class="nav-text">服务端：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A"><span class="nav-number">3.1.2.</span> <span class="nav-text">客户端：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frp%E6%90%AD%E5%BB%BA%E9%9A%A7%E9%81%93"><span class="nav-number">3.1.3.</span> <span class="nav-text">frp搭建隧道</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%84%E7%A7%8D%E5%B7%A5%E5%85%B7%E7%9A%84%E5%88%A9%E7%94%A8%E7%8E%AF%E5%A2%83"><span class="nav-number">4.</span> <span class="nav-text">各种工具的利用环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A4%96-gt-%E5%86%85"><span class="nav-number">4.0.1.</span> <span class="nav-text">1.外-&gt;内</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">4.0.2.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%86%85-gt-%E5%A4%96"><span class="nav-number">4.0.3.</span> <span class="nav-text">2.内-&gt;外</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="十三"
      src="/wan1/images/avatar.gif">
  <p class="site-author-name" itemprop="name">十三</p>
  <div class="site-description" itemprop="description">潜心学习，不骄不躁</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/wan1/archives/">
        
          <span class="site-state-item-count">172</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">十三</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/wan1/lib/anime.min.js"></script>
  <script src="/wan1/lib/velocity/velocity.min.js"></script>
  <script src="/wan1/lib/velocity/velocity.ui.min.js"></script>

<script src="/wan1/js/utils.js"></script>

<script src="/wan1/js/motion.js"></script>


<script src="/wan1/js/schemes/pisces.js"></script>


<script src="/wan1/js/next-boot.js"></script>




  




  
<script src="/wan1/js/local-search.js"></script>













  

  

<script src="/wan1/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"live2d-widget-model-tsumiki"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
